function copyAppSheetImages() {
  // === 設定部分 ===
  const sourceFolderId = "1j8VOQJzHn-U3NfF1NjX_agWatcMuoS7o"; // AppSheet画像フォルダ
  const targetFolderId = "1fTGEHh40QJz2i65Ym3IjGvMxj4xddsXQ"; // ← SharedImages フォルダID
  const sheetName = "全体活用記録";
  const photoColumnName = "写真1";     // ファイルパスが入っている列
  const urlColumnName = "写真のリンク"; // 公開URLを書き込む列

  // === 処理部分 ===
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();

  const headerRow = 2; // 2行目が見出し行
  const header = data[headerRow];
  const photoColIndex = header.indexOf(photoColumnName);
  const urlColIndex = header.indexOf(urlColumnName);

  if (photoColIndex === -1 || urlColIndex === -1) {
    Logger.log("❌ 列名が見つかりません。ヘッダー行を確認してください。");
    return;
  }

  const sourceFolder = DriveApp.getFolderById(sourceFolderId);
  const targetFolder = DriveApp.getFolderById(targetFolderId);
  const sourceFiles = sourceFolder.getFiles();
  const copiedFiles = {};

  while (sourceFiles.hasNext()) {
    const file = sourceFiles.next();
    copiedFiles[file.getName()] = file;
  }

  for (let i = headerRow + 1; i < data.length; i++) {
    const photoPath = data[i][photoColIndex];
    if (!photoPath || typeof photoPath !== "string") continue;

    const photoName = photoPath.split("/").pop();
    if (!photoName) continue;

    const existingUrl = data[i][urlColIndex];
    if (existingUrl && existingUrl.toString().startsWith("https://drive.google.com/uc")) continue;

    const file = copiedFiles[photoName];
    if (file) {
      // 同名ファイルがすでにあればそれを使用、なければコピー
      const existing = targetFolder.getFilesByName(photoName);
      let targetFile;
      if (existing.hasNext()) {
        targetFile = existing.next();
      } else {
        targetFile = file.makeCopy(photoName, targetFolder);
      }

      // ✅ 公開設定を「リンクを知っている全員」に変更
      targetFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

      // ✅ 画像URLを作成
      const url = "https://drive.google.com/uc?export=view&id=" + targetFile.getId();
      sheet.getRange(i + 1, urlColIndex + 1).setValue(url);
      Logger.log("✅ 公開URL作成: " + photoName + " → " + url);
    } else {
      Logger.log("⚠️ ファイル未検出: " + photoName);
    }
  }

  Logger.log("🎉 すべての処理が完了しました！");
}
