/**
 * ===============================================
 * AppSheetç”»åƒã‚’Driveå…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã¸ã‚³ãƒ”ãƒ¼ã—ã€
 * å…¬é–‹URLã‚’ç”Ÿæˆ ï¼‹ HTMLã§å®‰å…¨ã«ç”»åƒã‚’é…ä¿¡
 * ===============================================
 */

function copyAppSheetImages() {
  // === è¨­å®šéƒ¨åˆ† ===
  const sourceFolderId = "1j8VOQJzHn-U3NfF1NjX_agWatcMuoS7o"; // AppSheetç”»åƒãƒ•ã‚©ãƒ«ãƒ€
  const targetFolderId = "1fTGEHh40QJz2i65Ym3IjGvMxj4xddsXQ"; // SharedImages ãƒ•ã‚©ãƒ«ãƒ€ID
  const sheetName = "å…¨ä½“æ´»ç”¨è¨˜éŒ²";
  const photoColumnName = "å†™çœŸ1";     // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒå…¥ã£ã¦ã„ã‚‹åˆ—
  const urlColumnName = "å†™çœŸã®ãƒªãƒ³ã‚¯"; // å…¬é–‹URLã‚’æ›¸ãè¾¼ã‚€åˆ—

  // === å‡¦ç†éƒ¨åˆ† ===
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();

  const headerRow = 2; // 2è¡Œç›®ãŒãƒ˜ãƒƒãƒ€ãƒ¼
  const header = data[headerRow];
  const photoColIndex = header.indexOf(photoColumnName);
  const urlColIndex = header.indexOf(urlColumnName);

  if (photoColIndex === -1 || urlColIndex === -1) {
    Logger.log("âŒ åˆ—åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const sourceFolder = DriveApp.getFolderById(sourceFolderId);
  const targetFolder = DriveApp.getFolderById(targetFolderId);
  const sourceFiles = sourceFolder.getFiles();
  const copiedFiles = {};

  // ã‚½ãƒ¼ã‚¹ç”»åƒã®ä¸€è¦§ã‚’ä½œã‚‹
  while (sourceFiles.hasNext()) {
    const file = sourceFiles.next();
    copiedFiles[file.getName()] = file;
  }

  // å„è¡Œã‚’å‡¦ç†
  for (let i = headerRow + 1; i < data.length; i++) {
    const photoPath = data[i][photoColIndex];
    if (!photoPath || typeof photoPath !== "string") continue;

    const photoName = photoPath.split("/").pop();
    if (!photoName) continue;

    const existingUrl = data[i][urlColIndex];
    if (existingUrl && existingUrl.toString().startsWith("https://drive.google.com/uc")) continue;

    const file = copiedFiles[photoName];
    if (file) {
      // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãã›ãšå†åˆ©ç”¨
      const existing = targetFolder.getFilesByName(photoName);
      let targetFile;
      if (existing.hasNext()) {
        targetFile = existing.next();
      } else {
        targetFile = file.makeCopy(photoName, targetFolder);
      }

      // âœ… å…¬é–‹è¨­å®š
      targetFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

      // âœ… å…¬é–‹URLã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
      const url = "https://drive.google.com/uc?export=view&id=" + targetFile.getId();
      sheet.getRange(i + 1, urlColIndex + 1).setValue(url);

      Logger.log("âœ… å…¬é–‹URLä½œæˆ: " + photoName + " â†’ " + url);
    } else {
      Logger.log("âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æœªæ¤œå‡º: " + photoName);
    }
  }

  Logger.log("ğŸ‰ ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
}

/**
 * ===============================================
 * ç”»åƒä¸­ç¶™APIï¼ˆHTMLã§403å›é¿ï¼‰
 * https://script.google.com/macros/s/AKfycbx.../exec?path=ãƒˆãƒãƒˆ.å†™çœŸ1.111526.jpg
 * ===============================================
 */
function doGet(e) {
  const path = e.parameter.path;
  if (!path) return ContentService.createTextOutput("Missing 'path'");

  const folderId = "1fTGEHh40QJz2i65Ym3IjGvMxj4xddsXQ"; // SharedImages
  const folder = DriveApp.getFolderById(folderId);

  const parts = path.split("/");
  const fileName = parts.pop();
  let subfolder = folder;

  // ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
  for (const name of parts) {
    const next = subfolder.getFoldersByName(name);
    if (next.hasNext()) subfolder = next.next();
    else return ContentService.createTextOutput("Subfolder not found: " + name);
  }

  const files = subfolder.getFilesByName(fileName);
  if (!files.hasNext()) return ContentService.createTextOutput("File not found: " + fileName);

  const file = files.next();
  const blob = file.getBlob();

  // âœ… HTMLã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«è¿”ã™
  return ContentService.createBinaryOutput(blob).setMimeType(blob.getContentType());
}
